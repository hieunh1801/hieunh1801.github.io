---
// src/components/TextToSpeech.astro
export interface Props {
	text: string;
	lang?: string;
	class?: string;
}

const { text, lang, class: className } = Astro.props;

const detectedLang =
	lang ||
	(text.includes("đ") || text.includes("ả")
		? "vi-VN"
		: text.match(/[\u3131-\uD79D]/)
			? "ko-KR"
			: "en-US");
---

<div class={`inline-flex items-center gap-2 ${className || ""} justify-between w-full speak-line`}>
	<span set:text={text} />
	<button
		type="button"
		aria-label="Speak"
		class="speak-btn inline-flex h-6 w-6 items-center justify-center rounded-full bg-blue-100 text-blue-600 transition-colors duration-200 hover:bg-blue-200 focus:ring-2 focus:ring-blue-400 focus:outline-none"
		data-text={text}
		data-lang={detectedLang}
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			class="h-4 w-4"
			fill="none"
			viewBox="0 0 24 24"
			stroke="currentColor"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586m4.707-4.707C12.879 3.105 16.061 1 19.5 1c3.439 0 6.621 2.105 8.207 5.293"
			></path>
		</svg>
	</button>
</div>

<script>
	if (typeof window !== "undefined") {
		let utterance = null;
		let isSpeaking = false;

		document.addEventListener("click", (e) => {
			console.log(e);
			const btn = e?.target?.closest(".speak-btn") || e?.target?.closet("speak-line");
			if (!btn) {
				return;
			}

			const text = btn.dataset.text;
			const lang = btn.dataset.lang;

			if (isSpeaking) {
				speechSynthesis.cancel();
				isSpeaking = false;
				btn.classList.remove("speaking");
				return;
			}

			utterance = new SpeechSynthesisUtterance(text);
			utterance.lang = lang;
			utterance.rate = 0.9;

			utterance.onstart = () => {
				isSpeaking = true;
				btn.classList.add("speaking");
			};

			utterance.onend = utterance.onerror = () => {
				isSpeaking = false;
				btn.classList.remove("speaking");
			};

			speechSynthesis.speak(utterance);
		});

		window.addEventListener("beforeunload", () => speechSynthesis.cancel());
	}
</script>
