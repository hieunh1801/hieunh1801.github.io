---
// src/components/Mp3Player.astro
interface Props {
	src: string; // URL từ import ?url
	title?: string;
	loopSegment?: boolean;
}

const { src, title = "", loopSegment = true } = Astro.props;
---

<div
	class="mp3-player overflow-hidden rounded-xl border border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900"
>
	<!-- Header -->
	<div
		class="flex items-center justify-between border-b border-gray-200 bg-gray-50 px-4 py-2 dark:border-gray-700 dark:bg-gray-800"
	>
		{title && <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100">{title}</h4>}
		<button
			id="replayBtn"
			class="p-1.5 text-gray-500 transition-colors hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
			title="Replay 5s (Cmd/Ctrl + R)"
		>
			<svg
				xmlns="http://www.w3.org/2000/svg"
				class="h-4 w-4"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
			>
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M4 4v5h.582M20 12a8 8 0 11-16 0 8 8 0 0116 0zm-4-1a1 1 0 10-2 0v1a1 1 0 102 0v-1z"
				></path>
			</svg>
		</button>
	</div>

	<!-- Player Body -->
	<div class="flex items-center gap-4 p-4">
		<!-- Play/Pause Button -->
		<button
			id="playPauseBtn"
			class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-500 text-white transition-colors hover:bg-blue-600"
		>
			<svg class="play-icon ml-0.5 h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
				<path d="M8 5v14l11-7L8 5z"></path>
			</svg>
			<svg class="pause-icon hidden h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
				<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
			</svg>
		</button>

		<!-- Progress + Time -->
		<div class="min-w-0 flex-1">
			<div class="relative mb-1 h-1.5 overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700">
				<div
					id="progressFill"
					class="absolute top-0 left-0 h-full bg-blue-500 transition-all duration-75"
				>
				</div>
				<input
					type="range"
					id="seekBar"
					class="absolute inset-0 w-full cursor-pointer opacity-0"
					value="0"
					min="0"
					max="100"
					step="0.1"
				/>
			</div>
			<div class="flex justify-between font-mono text-xs text-gray-500 dark:text-gray-400">
				<span id="currentTime">0:00</span>
				<span id="duration">0:00</span>
			</div>
		</div>

		<!-- Seek Buttons -->
		<div class="flex gap-1">
			<button
				id="rewindBtn"
				class="p-2 text-gray-600 transition-colors hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
				title="Lùi 5s"
			>
				<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
					<path d="M11 18h2v-2h-2v2zM5 12h2v6H5v-6zm14 0h-2v6h2v-6zm-7-8v2H7V4h2zm5 0v2h-2V4h2z"
					></path>
					<path d="M12 8l-5 4 5 4V8zm1 0l5 4-5 4V8z"></path>
				</svg>
			</button>
			<button
				id="forwardBtn"
				class="p-2 text-gray-600 transition-colors hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200"
				title="Tiến 5s"
			>
				<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
					<path d="M11 18h2v-2h-2v2zM5 12h2v6H5v-6zm14 0h-2v6h2v-6zm-7-8v2H7V4h2zm5 0v2h-2V4h2z"
					></path>
					<path d="M12 8v8l5-4-5-4zm-1 0v8l-5-4 5-4z"></path>
				</svg>
			</button>
		</div>
	</div>
</div>

<!-- Hidden native audio -->
<audio id="audio" preload="metadata" client:load>
	<source src={src} type="audio/mpeg" />
</audio>

<script>
	if (typeof window !== "undefined") {
		const audio = document.getElementById("audio") as HTMLAudioElement;
		const playBtn = document.getElementById("playPauseBtn") as HTMLButtonElement;
		const playIcon = playBtn.querySelector(".play-icon")!;
		const pauseIcon = playBtn.querySelector(".pause-icon")!;
		const progressFill = document.getElementById("progressFill") as HTMLDivElement;
		const seekBar = document.getElementById("seekBar") as HTMLInputElement;
		const currentTimeEl = document.getElementById("currentTime") as HTMLSpanElement;
		const durationEl = document.getElementById("duration") as HTMLSpanElement;
		const rewindBtn = document.getElementById("rewindBtn") as HTMLButtonElement;
		const forwardBtn = document.getElementById("forwardBtn") as HTMLButtonElement;
		const replayBtn = document.getElementById("replayBtn") as HTMLButtonElement;

		let replayInterval: number | null = null;
		const REPLAY_DURATION = 5;
		let replayStart = 0;

		const formatTime = (sec: number) => {
			const m = Math.floor(sec / 60);
			const s = Math.floor(sec % 60);
			return `${m}:${s.toString().padStart(2, "0")}`;
		};

		const updateProgress = () => {
			if (!audio.duration) return;
			const percent = (audio.currentTime / audio.duration) * 100;
			progressFill.style.width = `${percent}%`;
			seekBar.value = percent.toString();
			currentTimeEl.textContent = formatTime(audio.currentTime);
		};

		// Play/Pause
		playBtn.addEventListener("click", () => {
			if (audio.paused) {
				audio.play();
				playIcon.classList.add("hidden");
				pauseIcon.classList.remove("hidden");
			} else {
				audio.pause();
				playIcon.classList.remove("hidden");
				pauseIcon.classList.add("hidden");
			}
		});

		// Audio events
		audio.addEventListener("loadedmetadata", () => {
			durationEl.textContent = formatTime(audio.duration);
		});

		audio.addEventListener("timeupdate", updateProgress);
		audio.addEventListener("ended", () => {
			playIcon.classList.remove("hidden");
			pauseIcon.classList.add("hidden");
		});

		// Seek
		seekBar.addEventListener("input", () => {
			const percent = parseFloat(seekBar.value);
			audio.currentTime = (percent / 100) * audio.duration;
		});

		// Seek ±5s
		const rewind = () => (audio.currentTime = Math.max(0, audio.currentTime - 5));
		const forward = () => (audio.currentTime = Math.min(audio.duration, audio.currentTime + 5));
		rewindBtn.addEventListener("click", rewind);
		forwardBtn.addEventListener("click", forward);

		// Replay
		const startReplay = () => {
			replayStart = Math.max(0, audio.currentTime - REPLAY_DURATION);
			audio.currentTime = replayStart;
			audio.play();
			playIcon.classList.add("hidden");
			pauseIcon.classList.remove("hidden");

			if (replayInterval) clearInterval(replayInterval);
			if (document.querySelector(".mp3-player")?.getAttribute("data-loop") === "true") {
				replayInterval = window.setInterval(() => {
					if (audio.currentTime >= replayStart + REPLAY_DURATION) {
						audio.currentTime = replayStart;
					}
				}, 50);
			}
		};
		replayBtn.addEventListener("click", startReplay);

		// Keyboard shortcuts
		const handleKey = (e: KeyboardEvent) => {
			if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === "r") {
				e.preventDefault();
				startReplay();
			} else if (e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey) {
				if (e.key === "ArrowLeft") {
					e.preventDefault();
					rewind();
				}
				if (e.key === "ArrowRight") {
					e.preventDefault();
					forward();
				}
			}
		};
		document.addEventListener("keydown", handleKey);

		// Cleanup
		const cleanup = () => {
			document.removeEventListener("keydown", handleKey);
			if (replayInterval) clearInterval(replayInterval);
		};
		window.addEventListener("beforeunload", cleanup);
	}
</script>
